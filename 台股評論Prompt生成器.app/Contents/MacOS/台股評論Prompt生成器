#!/bin/bash

# 台股評論 Prompt 生成器啟動腳本
APP_BUNDLE="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
PROJECT_DIR="$(dirname "$APP_BUNDLE")"
PYTHON_SCRIPT="$PROJECT_DIR/stock_prompt_generator.py"

# 快速檢查必要檔案和依賴
if [ ! -f "$PYTHON_SCRIPT" ]; then
    osascript -e 'display dialog "找不到程式檔案\n路徑：'"$PYTHON_SCRIPT"'" buttons {"確定"} with icon stop'
    exit 1
fi

if ! command -v python3 &> /dev/null; then
    osascript -e 'display dialog "未安裝 Python 3\n請先安裝 Python" buttons {"確定"} with icon stop'
    exit 1
fi

if ! python3 -c "import tkinter" 2>/dev/null; then
    osascript -e 'display dialog "缺少 tkinter\n請執行：brew install python-tk@3.11" buttons {"確定"} with icon stop'
    exit 1
fi

# 自動安裝 pyperclip（如果缺少）
if ! python3 -c "import pyperclip" 2>/dev/null; then
    python3 -m pip install pyperclip --user --break-system-packages 2>/dev/null || \
    python3 -m pip install pyperclip --user 2>/dev/null

    if ! python3 -c "import pyperclip" 2>/dev/null; then
        osascript -e 'display dialog "無法安裝 pyperclip\n請手動執行：pip install pyperclip --user" buttons {"確定"} with icon stop'
        exit 1
    fi
fi

# 切換到正確目錄並啟動
cd "$PROJECT_DIR"
exec python3 "$PYTHON_SCRIPT"